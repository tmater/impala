#
#
#  >> Test Data:e
#  > Small table with
#  - multiple snapshots
#  - multiple files
#  - delete files
#  > Big table
#  - lots of snapshots
#
#
#  >> Query each table at least once:
#    ENTRIES,x
#    FILES,x
#    DATA_FILES,x
#    DELETE_FILES,x
#    HISTORY,x
#    METADATA_LOG_ENTRIES,x
#    SNAPSHOTS,x
#    REFS,x
#    MANIFESTS,x
#    PARTITIONS,x
#    ALL_DATA_FILES,x
#    ALL_DELETE_FILES,
#    ALL_FILES,x
#    ALL_MANIFESTS,x
#    ALL_ENTRIES,x
#    POSITION_DELETES-n/a atm
# create table iceberg_test_metadata (i int) stored as iceberg TBLPROPERTIES('format-version' = '2'); 
# insert into iceberg_test_metadata values (1);
# insert into iceberg_test_metadata values (2);
# insert into iceberg_test_metadata values (3);
# delete from iceberg_test_metadata where i = 2;
####
# Test 0 : Query all the metadatata tables once
####
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.entries;
---- RESULTS
1,8283026816932323050,3,3
1,9046920472784493998,2,2
1,8491702501245661704,1,1
1,7858675898458780516,4,4
---- TYPES
INT,BIGINT,BIGINT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.`files`;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/944a2355e618932f-18f086b600000000_1283312202_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/3d481ed88b2941f0-ea33816200000000_1109948289_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/d64ba652b36f2d76-d075207600000000_883987622_data.0.parq','PARQUET',0,1,351,'',0
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-1f43b217940cc094-fedf515600000000_248998721_data.0.parq','PARQUET',0,1,1489,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.data_files;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/944a2355e618932f-18f086b600000000_1283312202_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/3d481ed88b2941f0-ea33816200000000_1109948289_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/d64ba652b36f2d76-d075207600000000_883987622_data.0.parq','PARQUET',0,1,351,'',0
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.delete_files;
---- RESULTS
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-1f43b217940cc094-fedf515600000000_248998721_data.0.parq','PARQUET',0,1,1489,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
2023-08-16 12:18:15.322000000,8491702501245661704,NULL,true
2023-08-16 12:18:15.523000000,9046920472784493998,8491702501245661704,true
2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,true
2023-08-16 12:18:18.584000000,7858675898458780516,8283026816932323050,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.metadata_log_entries;
---- RESULTS
2023-08-16 12:18:11.061000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00000-0ae98ebd-b200-4381-9d97-1f93954423a9.metadata.json',NULL,NULL,NULL
2023-08-16 12:18:15.323000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00001-a9e4a8c8-d0af-48d2-a964-5a15523112b1.metadata.json',8491702501245661704,0,1
2023-08-16 12:18:15.528000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00002-306a0b52-731c-484e-a9fe-47e947f8829e.metadata.json',9046920472784493998,0,2
2023-08-16 12:18:15.921000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00003-be3fa76d-a486-49c4-89ad-bf7eaba7b2ca.metadata.json',8283026816932323050,0,3
2023-08-16 12:18:18.589000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00004-a151e7c3-1a45-4f6d-af11-9901a0bce82a.metadata.json',7858675898458780516,0,4
---- TYPES
TIMESTAMP,STRING,BIGINT,INT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.snapshots;
---- RESULTS
2023-08-16 12:18:15.322000000,8491702501245661704,NULL,'append','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-8491702501245661704-1-88a39285-529f-41a4-bd69-6d2560fac64e.avro'
2023-08-16 12:18:15.523000000,9046920472784493998,8491702501245661704,'append','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-9046920472784493998-1-7c952273-c5d6-43d2-bb1b-72fbe1555f25.avro'
2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,'append','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-8283026816932323050-1-38e5a1bd-5b7f-4eae-9362-16a2de3c575d.avro'
2023-08-16 12:18:18.584000000,7858675898458780516,8283026816932323050,'overwrite','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-7858675898458780516-1-ef78f8eb-b2b5-41df-a2a0-7944ac3c38da.avro'
---- TYPES
TIMESTAMP,BIGINT,BIGINT,STRING,STRING
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.refs;
---- RESULTS
'main','BRANCH',7858675898458780516,NULL,NULL,NULL
---- TYPES
STRING,STRING,BIGINT,BIGINT,INT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.manifests;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/38e5a1bd-5b7f-4eae-9362-16a2de3c575d-m0.avro',6631,0,8283026816932323050,1,0,0,0,0,0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/7c952273-c5d6-43d2-bb1b-72fbe1555f25-m0.avro',6628,0,9046920472784493998,1,0,0,0,0,0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/88a39285-529f-41a4-bd69-6d2560fac64e-m0.avro',6627,0,8491702501245661704,1,0,0,0,0,0
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/ef78f8eb-b2b5-41df-a2a0-7944ac3c38da-m0.avro',6696,0,7858675898458780516,0,0,0,1,0,0
---- TYPES
INT,STRING,BIGINT,INT,BIGINT,INT,INT,INT,INT,INT,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.`partitions`;
---- RESULTS
3,3
---- TYPES
BIGINT,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_data_files;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/3d481ed88b2941f0-ea33816200000000_1109948289_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/944a2355e618932f-18f086b600000000_1283312202_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/d64ba652b36f2d76-d075207600000000_883987622_data.0.parq','PARQUET',0,1,351,'',0
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_delete_files;
---- RESULTS
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-1f43b217940cc094-fedf515600000000_248998721_data.0.parq','PARQUET',0,1,1489,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_files;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/3d481ed88b2941f0-ea33816200000000_1109948289_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/944a2355e618932f-18f086b600000000_1283312202_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/d64ba652b36f2d76-d075207600000000_883987622_data.0.parq','PARQUET',0,1,351,'',0
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-1f43b217940cc094-fedf515600000000_248998721_data.0.parq','PARQUET',0,1,1489,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_manifests;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/38e5a1bd-5b7f-4eae-9362-16a2de3c575d-m0.avro',6631,0,8283026816932323050,1,0,0,0,0,0,7858675898458780516
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/38e5a1bd-5b7f-4eae-9362-16a2de3c575d-m0.avro',6631,0,8283026816932323050,1,0,0,0,0,0,8283026816932323050
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/7c952273-c5d6-43d2-bb1b-72fbe1555f25-m0.avro',6628,0,9046920472784493998,1,0,0,0,0,0,7858675898458780516
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/7c952273-c5d6-43d2-bb1b-72fbe1555f25-m0.avro',6628,0,9046920472784493998,1,0,0,0,0,0,8283026816932323050
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/7c952273-c5d6-43d2-bb1b-72fbe1555f25-m0.avro',6628,0,9046920472784493998,1,0,0,0,0,0,9046920472784493998
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/88a39285-529f-41a4-bd69-6d2560fac64e-m0.avro',6627,0,8491702501245661704,1,0,0,0,0,0,7858675898458780516
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/88a39285-529f-41a4-bd69-6d2560fac64e-m0.avro',6627,0,8491702501245661704,1,0,0,0,0,0,8283026816932323050
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/88a39285-529f-41a4-bd69-6d2560fac64e-m0.avro',6627,0,8491702501245661704,1,0,0,0,0,0,8491702501245661704
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/88a39285-529f-41a4-bd69-6d2560fac64e-m0.avro',6627,0,8491702501245661704,1,0,0,0,0,0,9046920472784493998
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/ef78f8eb-b2b5-41df-a2a0-7944ac3c38da-m0.avro',6696,0,7858675898458780516,0,0,0,1,0,0,7858675898458780516
---- TYPES
INT,STRING,BIGINT,INT,BIGINT,INT,INT,INT,INT,INT,INT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_entries;
---- RESULTS
1,7858675898458780516,4,4
1,8283026816932323050,3,3
1,8491702501245661704,1,1
1,9046920472784493998,2,2
---- TYPES
INT,BIGINT,BIGINT,BIGINT

####
# Test 1 : Test select list
####
====
---- QUERY
select snapshot_id from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
7858675898458780516
8283026816932323050
8491702501245661704
9046920472784493998
---- TYPES
BIGINT
====
---- QUERY
select snapshot_id, * from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
7858675898458780516,2023-08-16 12:18:18.584000000,7858675898458780516,8283026816932323050,true
8283026816932323050,2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,true
8491702501245661704,2023-08-16 12:18:15.322000000,8491702501245661704,NULL,true
9046920472784493998,2023-08-16 12:18:15.523000000,9046920472784493998,8491702501245661704,true
---- TYPES
BIGINT,TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
select count(*) from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
4
---- TYPES
BIGINT
====
---- QUERY
select record_count + file_count from functional_parquet.iceberg_test_metadata.`partitions`;
---- RESULTS
6
---- TYPES
BIGINT


####
# Test 2 : Test filtering
####
====
---- QUERY
# Test BIGINT
select * from functional_parquet.iceberg_test_metadata.history
where snapshot_id = 8283026816932323050;
---- RESULTS
2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
# Test BOOLEAN
select * from functional_parquet.iceberg_test_metadata.history
where is_current_ancestor = true;
---- RESULTS
2023-08-16 12:18:15.322000000,8491702501245661704,NULL,true
2023-08-16 12:18:15.523000000,9046920472784493998,8491702501245661704,true
2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,true
2023-08-16 12:18:18.584000000,7858675898458780516,8283026816932323050,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
# Test STRING
select * from functional_parquet.iceberg_test_metadata.snapshots
where operation = 'overwrite';
---- RESULTS
2023-08-16 12:18:18.584000000,7858675898458780516,8283026816932323050,'overwrite','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-7858675898458780516-1-ef78f8eb-b2b5-41df-a2a0-7944ac3c38da.avro'
---- TYPES
TIMESTAMP,BIGINT,BIGINT,STRING,STRING
====
---- QUERY
# Test TIMESTAMP
select * from functional_parquet.iceberg_test_metadata.history
where made_current_at = cast("2023-08-16 12:18:15.919000000" as timestamp);
---- RESULTS
2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
# Test conjunct slot materialization
select snapshot_id from functional_parquet.iceberg_test_metadata.snapshots
where operation = 'overwrite';
---- RESULTS
7858675898458780516
---- TYPES
BIGINT
====
---- QUERY
# Test an expression rewrite: OR -> IN ()
select * from functional_parquet.iceberg_test_metadata.history
where snapshot_id = 9046920472784493998 or snapshot_id = 8283026816932323050;
---- RESULTS
2023-08-16 12:18:15.523000000,9046920472784493998,8491702501245661704,true
2023-08-16 12:18:15.919000000,8283026816932323050,9046920472784493998,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN

####
# Test 2 : Test joins
####
====
---- QUERY
select a.snapshot_id, b.snapshot_id from functional_parquet.iceberg_test_metadata.history a
join functional_parquet.iceberg_test_metadata.history b on a.snapshot_id = b.snapshot_id;
---- RESULTS
7858675898458780516,7858675898458780516
8283026816932323050,8283026816932323050
8491702501245661704,8491702501245661704
9046920472784493998,9046920472784493998
---- TYPES
BIGINT,BIGINT
====
---- QUERY
select a.snapshot_id, b.parent_id from functional_parquet.iceberg_test_metadata.history a
join functional_parquet.iceberg_test_metadata.history b on a.snapshot_id = b.snapshot_id;
---- RESULTS
7858675898458780516,8283026816932323050
8283026816932323050,9046920472784493998
8491702501245661704,NULL
9046920472784493998,8491702501245661704
---- TYPES
BIGINT,BIGINT
====
---- QUERY
select count(b.parent_id) from functional_parquet.iceberg_test_metadata.history a
join functional_parquet.iceberg_test_metadata.history b on a.snapshot_id = b.snapshot_id;
---- RESULTS
3
---- TYPES
BIGINT

####
# Test 3 : Inline query
####
====
---- QUERY
select a.snapshot_id
from (select * from functional_parquet.iceberg_test_metadata.history) a;
---- RESULTS
7858675898458780516
8283026816932323050
8491702501245661704
9046920472784493998
---- TYPES
BIGINT

####
# Test 4 : Complex types
# Currently not supported, complex type slots are set to NULL (IMPALA-12205)
####
====
---- QUERY
select snapshot_id, summary from functional_parquet.iceberg_test_metadata.snapshots;
---- RESULTS
7858675898458780516,'NULL'
8283026816932323050,'NULL'
8491702501245661704,'NULL'
9046920472784493998,'NULL'
---- TYPES
BIGINT,STRING
====