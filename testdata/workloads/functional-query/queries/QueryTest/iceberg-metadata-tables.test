#
#
#  >> Test Data:e
#  > Small table with
#  - multiple snapshots
#  - multiple files
#  - delete files
#  > Big table
#  - lots of snapshots
#
#
#  >> Query each table at least once:
#    ENTRIES,x
#    FILES,x
#    DATA_FILES,x
#    DELETE_FILES,x
#    HISTORY,x
#    METADATA_LOG_ENTRIES,x
#    SNAPSHOTS,x
#    REFS,x
#    MANIFESTS,x
#    PARTITIONS,x
#    ALL_DATA_FILES,x
#    ALL_DELETE_FILES,
#    ALL_FILES,x
#    ALL_MANIFESTS,x
#    ALL_ENTRIES,x
#    POSITION_DELETES-n/a atm
# create table iceberg_test_metadata (i int) stored as iceberg TBLPROPERTIES('format-version' = '2'); 
# insert into iceberg_test_metadata values (1);
# insert into iceberg_test_metadata values (2);
# insert into iceberg_test_metadata values (3);
# delete from iceberg_test_metadata where i = 2;
####
# Test 0 : Query all the metadatata tables once
####
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.entries;
---- RESULTS
1,3402808861336235366,3,3
1,6513109975109891247,2,2
1,7183548199109807016,1,1
1,6514678214355775093,4,4
---- TYPES
INT,BIGINT,BIGINT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.`files`;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/6a42802e7a2f5fb3-89101f9b00000000_2097425411_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/e34a6712ccf94419-6d413a4d00000000_740167329_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/664b6781de8d6696-1acc96f400000000_1028080785_data.0.parq','PARQUET',0,1,351,'',0
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-624e56c9f78bc318-76b3efa700000000_1597533319_data.0.parq','PARQUET',0,1,1484,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.data_files;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/6a42802e7a2f5fb3-89101f9b00000000_2097425411_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/e34a6712ccf94419-6d413a4d00000000_740167329_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/664b6781de8d6696-1acc96f400000000_1028080785_data.0.parq','PARQUET',0,1,351,'',0
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.delete_files;
---- RESULTS
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-624e56c9f78bc318-76b3efa700000000_1597533319_data.0.parq','PARQUET',0,1,1484,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
2023-07-21 09:56:55.109000000,7183548199109807016,NULL,true
2023-07-21 09:56:55.450000000,6513109975109891247,7183548199109807016,true
2023-07-21 09:56:55.762000000,3402808861336235366,6513109975109891247,true
2023-07-21 09:56:56.280000000,6514678214355775093,3402808861336235366,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.metadata_log_entries;
---- RESULTS
2023-07-21 09:56:50.677000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00000-9ddfaef7-9f70-4750-87c6-77267ecbae63.metadata.json',NULL,NULL,NULL
2023-07-21 09:56:55.122000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00001-52388d45-2d58-4b85-ae06-2b10110a3bc8.metadata.json',7183548199109807016,0,1
2023-07-21 09:56:55.452000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00002-c055cfe8-4762-4349-a1fd-d163bd23f9c2.metadata.json',6513109975109891247,0,2
2023-07-21 09:56:55.769000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00003-fba22477-68d3-45d5-94cd-69bb8f2ec5ec.metadata.json',3402808861336235366,0,3
2023-07-21 09:56:56.290000000,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/00004-2cac6d63-a93f-4c4e-955c-ff758cacdc49.metadata.json',6514678214355775093,0,4
---- TYPES
TIMESTAMP,STRING,BIGINT,INT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.snapshots;
---- RESULTS
2023-07-21 09:56:55.109000000,7183548199109807016,NULL,'append','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-7183548199109807016-1-324cb3a6-248c-4fb3-9924-62a9a8fbbd69.avro'
2023-07-21 09:56:55.450000000,6513109975109891247,7183548199109807016,'append','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-6513109975109891247-1-bae2a3d5-2faa-42b6-af63-947954d4ba8e.avro'
2023-07-21 09:56:55.762000000,3402808861336235366,6513109975109891247,'append','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-3402808861336235366-1-5a7d6cc3-6ed6-40dd-8c2b-e0252dcbfcc0.avro'
2023-07-21 09:56:56.280000000,6514678214355775093,3402808861336235366,'overwrite','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-6514678214355775093-1-87ded59b-86c3-4346-a3a8-285f1611d6b9.avro'
---- TYPES
TIMESTAMP,BIGINT,BIGINT,STRING,STRING
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.refs;
---- RESULTS
'main','BRANCH',6514678214355775093,NULL,NULL,NULL
---- TYPES
STRING,STRING,BIGINT,BIGINT,INT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.manifests;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/5a7d6cc3-6ed6-40dd-8c2b-e0252dcbfcc0-m0.avro',6627,0,3402808861336235366,1,0,0,0,0,0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/bae2a3d5-2faa-42b6-af63-947954d4ba8e-m0.avro',6627,0,6513109975109891247,1,0,0,0,0,0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/324cb3a6-248c-4fb3-9924-62a9a8fbbd69-m0.avro',6631,0,7183548199109807016,1,0,0,0,0,0
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/87ded59b-86c3-4346-a3a8-285f1611d6b9-m0.avro',6696,0,6514678214355775093,0,0,0,1,0,0
---- TYPES
INT,STRING,BIGINT,INT,BIGINT,INT,INT,INT,INT,INT,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.`partitions`;
---- RESULTS
3,3
---- TYPES
BIGINT,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_data_files;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/6a42802e7a2f5fb3-89101f9b00000000_2097425411_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/e34a6712ccf94419-6d413a4d00000000_740167329_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/664b6781de8d6696-1acc96f400000000_1028080785_data.0.parq','PARQUET',0,1,351,'',0
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_delete_files;
---- RESULTS
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-624e56c9f78bc318-76b3efa700000000_1597533319_data.0.parq','PARQUET',0,1,1484,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_files;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/6a42802e7a2f5fb3-89101f9b00000000_2097425411_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/e34a6712ccf94419-6d413a4d00000000_740167329_data.0.parq','PARQUET',0,1,351,'',0
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/664b6781de8d6696-1acc96f400000000_1028080785_data.0.parq','PARQUET',0,1,351,'',0
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/data/delete-624e56c9f78bc318-76b3efa700000000_1597533319_data.0.parq','PARQUET',0,1,1484,'NULL',NULL
---- TYPES
INT,STRING,STRING,INT,BIGINT,BIGINT,BINARY,INT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_manifests;
---- RESULTS
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/324cb3a6-248c-4fb3-9924-62a9a8fbbd69-m0.avro',6631,0,7183548199109807016,1,0,0,0,0,0,7183548199109807016
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/bae2a3d5-2faa-42b6-af63-947954d4ba8e-m0.avro',6627,0,6513109975109891247,1,0,0,0,0,0,6513109975109891247
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/324cb3a6-248c-4fb3-9924-62a9a8fbbd69-m0.avro',6631,0,7183548199109807016,1,0,0,0,0,0,6513109975109891247
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/5a7d6cc3-6ed6-40dd-8c2b-e0252dcbfcc0-m0.avro',6627,0,3402808861336235366,1,0,0,0,0,0,3402808861336235366
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/bae2a3d5-2faa-42b6-af63-947954d4ba8e-m0.avro',6627,0,6513109975109891247,1,0,0,0,0,0,3402808861336235366
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/324cb3a6-248c-4fb3-9924-62a9a8fbbd69-m0.avro',6631,0,7183548199109807016,1,0,0,0,0,0,3402808861336235366
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/5a7d6cc3-6ed6-40dd-8c2b-e0252dcbfcc0-m0.avro',6627,0,3402808861336235366,1,0,0,0,0,0,6514678214355775093
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/bae2a3d5-2faa-42b6-af63-947954d4ba8e-m0.avro',6627,0,6513109975109891247,1,0,0,0,0,0,6514678214355775093
0,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/324cb3a6-248c-4fb3-9924-62a9a8fbbd69-m0.avro',6631,0,7183548199109807016,1,0,0,0,0,0,6514678214355775093
1,'hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/87ded59b-86c3-4346-a3a8-285f1611d6b9-m0.avro',6696,0,6514678214355775093,0,0,0,1,0,0,6514678214355775093
---- TYPES
INT,STRING,BIGINT,INT,BIGINT,INT,INT,INT,INT,INT,INT,BIGINT
====
---- QUERY
select * from functional_parquet.iceberg_test_metadata.all_entries;
---- RESULTS
1,3402808861336235366,3,3
1,6514678214355775093,4,4
1,6513109975109891247,2,2
1,7183548199109807016,1,1
---- TYPES
INT,BIGINT,BIGINT,BIGINT

####
# Test 1 : Test select list
####
====
---- QUERY
select snapshot_id from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
7183548199109807016
6513109975109891247
3402808861336235366
6514678214355775093
---- TYPES
BIGINT
====
---- QUERY
select snapshot_id, * from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
7183548199109807016,2023-07-21 09:56:55.109000000,7183548199109807016,NULL,true
6513109975109891247,2023-07-21 09:56:55.450000000,6513109975109891247,7183548199109807016,true
3402808861336235366,2023-07-21 09:56:55.762000000,3402808861336235366,6513109975109891247,true
6514678214355775093,2023-07-21 09:56:56.280000000,6514678214355775093,3402808861336235366,true
---- TYPES
BIGINT,TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
select count(*) from functional_parquet.iceberg_test_metadata.history;
---- RESULTS
4
---- TYPES
BIGINT
====
---- QUERY
select record_count + file_count from functional_parquet.iceberg_test_metadata.`partitions`;
---- RESULTS
6
---- TYPES
BIGINT


####
# Test 2 : Test filtering
####
====
---- QUERY
# Test BIGINT
select * from functional_parquet.iceberg_test_metadata.history
where snapshot_id = 3402808861336235366;
---- RESULTS
2023-07-21 09:56:55.762000000,3402808861336235366,6513109975109891247,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
# Test BOOLEAN
select * from functional_parquet.iceberg_test_metadata.history
where is_current_ancestor = true;
---- RESULTS
2023-07-21 09:56:55.109000000,7183548199109807016,NULL,true
2023-07-21 09:56:55.450000000,6513109975109891247,7183548199109807016,true
2023-07-21 09:56:55.762000000,3402808861336235366,6513109975109891247,true
2023-07-21 09:56:56.280000000,6514678214355775093,3402808861336235366,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
# Test STRING
select * from functional_parquet.iceberg_test_metadata.snapshots
where operation = 'overwrite';
---- RESULTS
2023-07-21 09:56:56.280000000,6514678214355775093,3402808861336235366,'overwrite','hdfs://localhost:20500/test-warehouse/functional_parquet.db/iceberg_test_metadata/metadata/snap-6514678214355775093-1-87ded59b-86c3-4346-a3a8-285f1611d6b9.avro'
---- TYPES
TIMESTAMP,BIGINT,BIGINT,STRING,STRING
====
---- QUERY
# Test TIMESTAMP
select * from functional_parquet.iceberg_test_metadata.history
where made_current_at = cast("2023-07-21 09:56:55.450000000" as timestamp);
---- RESULTS
2023-07-21 09:56:55.450000000,6513109975109891247,7183548199109807016,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN
====
---- QUERY
# Test conjunct slot materialization
select snapshot_id from functional_parquet.iceberg_test_metadata.snapshots
where operation = 'overwrite';
---- RESULTS
6514678214355775093
---- TYPES
BIGINT
====
---- QUERY
# Test an expression rewrite: OR -> IN ()
select * from functional_parquet.iceberg_test_metadata.history
where snapshot_id = 3402808861336235366 or snapshot_id = 6513109975109891247;
---- RESULTS
2023-07-21 09:56:55.450000000,6513109975109891247,7183548199109807016,true
2023-07-21 09:56:55.762000000,3402808861336235366,6513109975109891247,true
---- TYPES
TIMESTAMP,BIGINT,BIGINT,BOOLEAN

####
# Test 2 : Test joins
####
====
---- QUERY
select a.snapshot_id, b.snapshot_id from functional_parquet.iceberg_test_metadata.history a
join functional_parquet.iceberg_test_metadata.history b on a.snapshot_id = b.snapshot_id;
---- RESULTS
7183548199109807016,7183548199109807016
6513109975109891247,6513109975109891247
3402808861336235366,3402808861336235366
6514678214355775093,6514678214355775093
---- TYPES
BIGINT,BIGINT
====
---- QUERY
select a.snapshot_id, b.parent_id from functional_parquet.iceberg_test_metadata.history a
join functional_parquet.iceberg_test_metadata.history b on a.snapshot_id = b.snapshot_id;
---- RESULTS
7183548199109807016,NULL
6513109975109891247,7183548199109807016
3402808861336235366,6513109975109891247
6514678214355775093,3402808861336235366
---- TYPES
BIGINT,BIGINT
====
---- QUERY
select count(b.parent_id) from functional_parquet.iceberg_test_metadata.history a
join functional_parquet.iceberg_test_metadata.history b on a.snapshot_id = b.snapshot_id;
---- RESULTS
3
---- TYPES
BIGINT

####
# Test 3 : Inline query
####
====
---- QUERY
select a.snapshot_id
from (select * from functional_parquet.iceberg_test_metadata.history) a;
---- RESULTS
7183548199109807016
6513109975109891247
3402808861336235366
6514678214355775093
---- TYPES
BIGINT

####
# Test 4 : Complex types
# Currently not supported, complex type slots are set to NULL (IMPALA-12205)
####
====
---- QUERY
select snapshot_id, summary from functional_parquet.iceberg_test_metadata.snapshots;
---- RESULTS
7183548199109807016,'NULL'
6513109975109891247,'NULL'
3402808861336235366,'NULL'
6514678214355775093,'NULL'
---- TYPES
BIGINT,STRING
====